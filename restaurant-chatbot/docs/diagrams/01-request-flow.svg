<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 1000" font-family="Segoe UI, Arial, sans-serif">
  <defs>
    <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#1a1a2e"/>
      <stop offset="100%" style="stop-color:#16213e"/>
    </linearGradient>
    <linearGradient id="userGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#f39c12"/>
      <stop offset="100%" style="stop-color:#d68910"/>
    </linearGradient>
    <linearGradient id="nginxGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#009639"/>
      <stop offset="100%" style="stop-color:#006d2c"/>
    </linearGradient>
    <linearGradient id="wsGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#9b59b6"/>
      <stop offset="100%" style="stop-color:#8e44ad"/>
    </linearGradient>
    <linearGradient id="apiGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#009688"/>
      <stop offset="100%" style="stop-color:#00796b"/>
    </linearGradient>
    <linearGradient id="authGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#e74c3c"/>
      <stop offset="100%" style="stop-color:#c0392b"/>
    </linearGradient>
    <linearGradient id="crewaiGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ff6b6b"/>
      <stop offset="100%" style="stop-color:#ee5a24"/>
    </linearGradient>
    <linearGradient id="agentGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#667eea"/>
      <stop offset="100%" style="stop-color:#764ba2"/>
    </linearGradient>
    <linearGradient id="toolGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#e67e22"/>
      <stop offset="100%" style="stop-color:#d35400"/>
    </linearGradient>
    <linearGradient id="dbGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#336791"/>
      <stop offset="100%" style="stop-color:#1d4f6e"/>
    </linearGradient>
    <linearGradient id="llmGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#412991"/>
      <stop offset="100%" style="stop-color:#2d1a66"/>
    </linearGradient>
    <linearGradient id="redisGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#dc382d"/>
      <stop offset="100%" style="stop-color:#a41e11"/>
    </linearGradient>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="3" stdDeviation="3" flood-opacity="0.3"/>
    </filter>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#667"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#ee5a24"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#27ae60"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1400" height="1000" fill="#f5f7fa"/>

  <!-- Header -->
  <rect x="0" y="0" width="1400" height="60" fill="url(#headerGrad)"/>
  <text x="700" y="38" text-anchor="middle" fill="white" font-size="24" font-weight="bold">Request Flow Architecture - End to End Message Journey</text>

  <!-- Step Numbers -->
  <g font-size="14" font-weight="bold">
    <!-- Step 1 -->
    <circle cx="100" cy="150" r="18" fill="#3498db"/>
    <text x="100" y="155" text-anchor="middle" fill="white">1</text>

    <!-- Step 2 -->
    <circle cx="100" cy="280" r="18" fill="#3498db"/>
    <text x="100" y="285" text-anchor="middle" fill="white">2</text>

    <!-- Step 3 -->
    <circle cx="100" cy="410" r="18" fill="#ee5a24"/>
    <text x="100" y="415" text-anchor="middle" fill="white">3</text>

    <!-- Step 4 -->
    <circle cx="100" cy="540" r="18" fill="#3498db"/>
    <text x="100" y="545" text-anchor="middle" fill="white">4</text>

    <!-- Step 5 -->
    <circle cx="100" cy="670" r="18" fill="#3498db"/>
    <text x="100" y="675" text-anchor="middle" fill="white">5</text>

    <!-- Step 6 -->
    <circle cx="100" cy="800" r="18" fill="#3498db"/>
    <text x="100" y="805" text-anchor="middle" fill="white">6</text>
  </g>

  <!-- STEP 1: User sends message -->
  <g transform="translate(140, 100)">
    <rect width="1220" height="110" rx="10" fill="white" stroke="#ddd" filter="url(#shadow)"/>
    <text x="20" y="25" font-size="14" font-weight="bold" fill="#333">STEP 1: User Sends Message</text>

    <!-- User -->
    <g transform="translate(40, 40)">
      <circle cx="25" cy="15" r="15" fill="url(#userGrad)"/>
      <rect x="10" y="35" width="30" height="25" rx="5" fill="url(#userGrad)"/>
      <text x="25" y="80" text-anchor="middle" font-size="10" fill="#666">User</text>
    </g>

    <!-- Browser -->
    <g transform="translate(120, 35)">
      <rect width="140" height="70" rx="5" fill="#fff" stroke="#3498db" stroke-width="2"/>
      <rect x="5" y="5" width="130" height="20" rx="3" fill="#ecf0f1"/>
      <circle cx="15" cy="15" r="4" fill="#e74c3c"/>
      <circle cx="28" cy="15" r="4" fill="#f1c40f"/>
      <circle cx="41" cy="15" r="4" fill="#27ae60"/>
      <text x="70" y="50" text-anchor="middle" font-size="9" fill="#333">React Chat Widget</text>
      <text x="70" y="62" text-anchor="middle" font-size="8" fill="#666">TypeScript + Vite</text>
    </g>

    <!-- Arrow -->
    <path d="M280 70 L350 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>
    <text x="315" y="60" text-anchor="middle" font-size="9" fill="#666">WebSocket</text>

    <!-- Message Box -->
    <g transform="translate(370, 35)">
      <rect width="200" height="70" rx="5" fill="#e8f6f3" stroke="#1abc9c"/>
      <text x="100" y="20" text-anchor="middle" font-size="10" font-weight="bold" fill="#16a085">Message Payload</text>
      <text x="10" y="38" font-size="8" fill="#333" font-family="monospace">{</text>
      <text x="20" y="48" font-size="8" fill="#333" font-family="monospace">"message": "Show biryani"</text>
      <text x="20" y="58" font-size="8" fill="#333" font-family="monospace">"session_id": "abc123"</text>
      <text x="10" y="68" font-size="8" fill="#333" font-family="monospace">}</text>
    </g>

    <!-- Arrow -->
    <path d="M590 70 L660 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- NGINX -->
    <g transform="translate(680, 30)">
      <rect width="120" height="75" rx="8" fill="url(#nginxGrad)" filter="url(#shadow)"/>
      <text x="60" y="25" text-anchor="middle" fill="white" font-size="16" font-weight="bold">NGINX</text>
      <text x="60" y="42" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="9">Reverse Proxy</text>
      <text x="60" y="55" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">SSL Termination</text>
      <text x="60" y="68" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="8">Port 80 â†’ 8000</text>
    </g>

    <!-- Arrow to FastAPI -->
    <path d="M820 70 L890 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>
    <text x="855" y="60" text-anchor="middle" font-size="9" fill="#666">HTTP</text>

    <!-- FastAPI -->
    <g transform="translate(910, 30)">
      <rect width="280" height="75" rx="8" fill="url(#apiGrad)" filter="url(#shadow)"/>
      <text x="140" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="bold">FastAPI Application</text>
      <text x="70" y="45" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="9">WebSocket</text>
      <text x="70" y="58" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">/chat/{session}</text>
      <text x="200" y="45" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="9">REST API</text>
      <text x="200" y="58" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">/api/v1/*</text>
      <text x="140" y="70" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="8">Uvicorn ASGI Server</text>
    </g>
  </g>

  <!-- STEP 2: Session & Auth Check -->
  <g transform="translate(140, 230)">
    <rect width="1220" height="110" rx="10" fill="white" stroke="#ddd" filter="url(#shadow)"/>
    <text x="20" y="25" font-size="14" font-weight="bold" fill="#333">STEP 2: Session Validation &amp; Authentication</text>

    <!-- chat.py -->
    <g transform="translate(40, 35)">
      <rect width="150" height="70" rx="5" fill="#e8f4f8" stroke="#3498db"/>
      <text x="75" y="20" text-anchor="middle" font-size="10" font-weight="bold" fill="#2980b9">chat.py</text>
      <text x="75" y="35" text-anchor="middle" font-size="8" fill="#666">WebSocket Handler</text>
      <text x="75" y="48" text-anchor="middle" font-size="8" fill="#666">@router.websocket</text>
      <text x="75" y="61" text-anchor="middle" font-size="8" fill="#666">("/chat/{session_id}")</text>
    </g>

    <path d="M210 70 L270 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- Session Check -->
    <g transform="translate(290, 35)">
      <polygon points="75,0 150,35 75,70 0,35" fill="#fef9e7" stroke="#f39c12"/>
      <text x="75" y="32" text-anchor="middle" font-size="9" font-weight="bold" fill="#d68910">Session</text>
      <text x="75" y="44" text-anchor="middle" font-size="9" font-weight="bold" fill="#d68910">Valid?</text>
    </g>

    <!-- Redis Session Store -->
    <g transform="translate(290, -5)">
      <rect width="150" height="35" rx="5" fill="url(#redisGrad)"/>
      <text x="75" y="22" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Redis Session Store</text>
    </g>
    <path d="M365 35 L365 15" stroke="#dc382d" stroke-width="1" stroke-dasharray="3,2"/>

    <path d="M460 70 L520 70" stroke="#27ae60" stroke-width="2" marker-end="url(#arrowGreen)"/>
    <text x="490" y="60" font-size="8" fill="#27ae60">Yes</text>

    <!-- Auth Required Decision -->
    <g transform="translate(540, 35)">
      <polygon points="75,0 150,35 75,70 0,35" fill="#fdedec" stroke="#e74c3c"/>
      <text x="75" y="32" text-anchor="middle" font-size="9" font-weight="bold" fill="#c0392b">Auth</text>
      <text x="75" y="44" text-anchor="middle" font-size="9" font-weight="bold" fill="#c0392b">Required?</text>
    </g>

    <path d="M710 70 L770 70" stroke="#27ae60" stroke-width="2" marker-end="url(#arrowGreen)"/>
    <text x="740" y="60" font-size="8" fill="#27ae60">Authenticated</text>

    <!-- Auth Service (if needed) -->
    <g transform="translate(540, -5)">
      <rect width="150" height="35" rx="5" fill="url(#authGrad)"/>
      <text x="75" y="15" text-anchor="middle" fill="white" font-size="9" font-weight="bold">Identity Service</text>
      <text x="75" y="27" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">OTP Verification</text>
    </g>
    <path d="M615 35 L615 15" stroke="#e74c3c" stroke-width="1" stroke-dasharray="3,2"/>

    <!-- Context Setup -->
    <g transform="translate(790, 35)">
      <rect width="180" height="70" rx="5" fill="#eaf2f8" stroke="#5dade2"/>
      <text x="90" y="18" text-anchor="middle" font-size="10" font-weight="bold" fill="#2e86c1">Session Context Setup</text>
      <text x="10" y="35" font-size="8" fill="#333" font-family="monospace">set_session_context(</text>
      <text x="20" y="47" font-size="8" fill="#333" font-family="monospace">user_id="usr_123"</text>
      <text x="20" y="59" font-size="8" fill="#333" font-family="monospace">session_id="abc123"</text>
      <text x="10" y="68" font-size="8" fill="#333" font-family="monospace">)</text>
    </g>

    <path d="M990 70 L1050 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- ContextVar -->
    <g transform="translate(1070, 35)">
      <rect width="130" height="70" rx="5" fill="#f4ecf7" stroke="#9b59b6"/>
      <text x="65" y="20" text-anchor="middle" font-size="10" font-weight="bold" fill="#8e44ad">ContextVar</text>
      <text x="65" y="38" text-anchor="middle" font-size="8" fill="#666">Thread-Safe</text>
      <text x="65" y="50" text-anchor="middle" font-size="8" fill="#666">User Context</text>
      <text x="65" y="62" text-anchor="middle" font-size="8" fill="#666">Propagation</text>
    </g>
  </g>

  <!-- STEP 3: CrewAI Processing -->
  <g transform="translate(140, 360)">
    <rect width="1220" height="110" rx="10" fill="white" stroke="#ee5a24" stroke-width="2" filter="url(#shadow)"/>
    <text x="20" y="25" font-size="14" font-weight="bold" fill="#ee5a24">STEP 3: CrewAI Agent Orchestration</text>

    <!-- Message arrives -->
    <g transform="translate(40, 35)">
      <rect width="120" height="70" rx="5" fill="#ebf5fb" stroke="#3498db"/>
      <text x="60" y="20" text-anchor="middle" font-size="9" font-weight="bold" fill="#2980b9">User Message</text>
      <text x="60" y="38" text-anchor="middle" font-size="8" fill="#666">"Show me biryani</text>
      <text x="60" y="50" text-anchor="middle" font-size="8" fill="#666">options under</text>
      <text x="60" y="62" text-anchor="middle" font-size="8" fill="#666">Rs.300"</text>
    </g>

    <path d="M180 70 L240 70" stroke="#ee5a24" stroke-width="2" marker-end="url(#arrowOrange)"/>

    <!-- CrewAI -->
    <g transform="translate(260, 30)">
      <rect width="200" height="75" rx="8" fill="url(#crewaiGrad)" filter="url(#shadow)"/>
      <text x="100" y="22" text-anchor="middle" fill="white" font-size="12" font-weight="bold">CrewAI</text>
      <text x="100" y="38" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="9">Process.sequential</text>
      <text x="50" y="55" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">Crew</text>
      <text x="100" y="55" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">Agent</text>
      <text x="150" y="55" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">Task</text>
      <text x="100" y="70" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="8">akickoff() - Native Async</text>
    </g>

    <path d="M480 70 L540 70" stroke="#ee5a24" stroke-width="2" marker-end="url(#arrowOrange)"/>

    <!-- Task Processing -->
    <g transform="translate(560, 30)">
      <rect width="160" height="75" rx="5" fill="#fff5f5" stroke="#ee5a24"/>
      <text x="80" y="20" text-anchor="middle" font-size="10" font-weight="bold" fill="#ee5a24">Task Inputs</text>
      <text x="80" y="38" text-anchor="middle" font-size="8" fill="#666">user_input + context</text>
      <text x="80" y="50" text-anchor="middle" font-size="8" fill="#666">semantic_context</text>
      <text x="80" y="62" text-anchor="middle" font-size="8" fill="#666">(Entity Graph)</text>
    </g>

    <path d="M740 70 L800 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- Agent Selection -->
    <g transform="translate(820, 35)">
      <polygon points="70,0 140,35 70,70 0,35" fill="#fff5f5" stroke="#ee5a24"/>
      <text x="70" y="28" text-anchor="middle" font-size="9" font-weight="bold" fill="#ee5a24">Delegate?</text>
      <text x="70" y="44" text-anchor="middle" font-size="8" fill="#d35400">allow_delegation</text>
    </g>

    <path d="M980 70 L1040 70" stroke="#27ae60" stroke-width="2" marker-end="url(#arrowGreen)"/>

    <!-- Food Ordering Agent -->
    <g transform="translate(1060, 30)">
      <rect width="140" height="75" rx="8" fill="url(#agentGrad)" filter="url(#shadow)"/>
      <text x="70" y="18" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Kavya</text>
      <text x="70" y="32" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="8">Food Ordering Agent</text>
      <text x="70" y="48" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="7">search_menu_tool</text>
      <text x="70" y="58" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="7">add_to_cart_tool</text>
      <text x="70" y="68" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="7">GPT-4o reasoning</text>
    </g>
  </g>

  <!-- STEP 4: Tool Execution -->
  <g transform="translate(140, 490)">
    <rect width="1220" height="110" rx="10" fill="white" stroke="#ddd" filter="url(#shadow)"/>
    <text x="20" y="25" font-size="14" font-weight="bold" fill="#333">STEP 4: Tool Execution &amp; Database Queries</text>

    <!-- Tool Call -->
    <g transform="translate(40, 35)">
      <rect width="160" height="70" rx="5" fill="url(#toolGrad)" filter="url(#shadow)"/>
      <text x="80" y="20" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Tool: search_menu</text>
      <text x="80" y="38" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="8">query="biryani"</text>
      <text x="80" y="50" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="8">max_price=300</text>
      <text x="80" y="62" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">session_id closure</text>
    </g>

    <path d="M220 70 L280 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- Factory Pattern -->
    <g transform="translate(300, 35)">
      <rect width="140" height="70" rx="5" fill="#fef5e7" stroke="#f39c12"/>
      <text x="70" y="18" text-anchor="middle" font-size="9" font-weight="bold" fill="#d68910">Factory Pattern</text>
      <text x="70" y="35" text-anchor="middle" font-size="8" fill="#666">create_search_menu_tool</text>
      <text x="70" y="48" text-anchor="middle" font-size="8" fill="#666">(session_id)</text>
      <text x="70" y="62" text-anchor="middle" font-size="8" fill="#666">Thread-safe closure</text>
    </g>

    <path d="M460 70 L520 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- Service Layer -->
    <g transform="translate(540, 35)">
      <rect width="150" height="70" rx="5" fill="#eaf2f8" stroke="#3498db"/>
      <text x="75" y="18" text-anchor="middle" font-size="9" font-weight="bold" fill="#2980b9">Service Layer</text>
      <text x="75" y="35" text-anchor="middle" font-size="8" fill="#666">MenuService</text>
      <text x="75" y="48" text-anchor="middle" font-size="8" fill="#666">search_items_async()</text>
      <text x="75" y="61" text-anchor="middle" font-size="8" fill="#666">Business Logic</text>
    </g>

    <path d="M710 70 L770 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- SQLAlchemy -->
    <g transform="translate(790, 35)">
      <rect width="140" height="70" rx="5" fill="#e8f6f3" stroke="#1abc9c"/>
      <text x="70" y="18" text-anchor="middle" font-size="9" font-weight="bold" fill="#16a085">SQLAlchemy</text>
      <text x="70" y="35" text-anchor="middle" font-size="8" fill="#666">Async Session</text>
      <text x="70" y="48" text-anchor="middle" font-size="8" fill="#666">select(MenuItem)</text>
      <text x="70" y="61" text-anchor="middle" font-size="8" fill="#666">.filter(...)</text>
    </g>

    <path d="M950 70 L1010 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- PostgreSQL -->
    <g transform="translate(1030, 30)">
      <rect width="160" height="75" rx="8" fill="url(#dbGrad)" filter="url(#shadow)"/>
      <ellipse cx="80" cy="20" rx="25" ry="10" fill="white" opacity="0.9"/>
      <rect x="55" y="20" width="50" height="20" fill="white" opacity="0.9"/>
      <ellipse cx="80" cy="40" rx="25" ry="10" fill="white" opacity="0.9"/>
      <text x="80" y="58" text-anchor="middle" fill="white" font-size="11" font-weight="bold">PostgreSQL</text>
      <text x="80" y="70" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">menu_item table</text>
    </g>
  </g>

  <!-- STEP 5: LLM Response Generation -->
  <g transform="translate(140, 620)">
    <rect width="1220" height="110" rx="10" fill="white" stroke="#ddd" filter="url(#shadow)"/>
    <text x="20" y="25" font-size="14" font-weight="bold" fill="#333">STEP 5: LLM Response Generation</text>

    <!-- Tool Results -->
    <g transform="translate(40, 35)">
      <rect width="180" height="70" rx="5" fill="#e8f8f5" stroke="#27ae60"/>
      <text x="90" y="18" text-anchor="middle" font-size="9" font-weight="bold" fill="#1e8449">Tool Results</text>
      <text x="10" y="35" font-size="7" fill="#333" font-family="monospace">[MenuItem(name="Hyderabadi</text>
      <text x="10" y="45" font-size="7" fill="#333" font-family="monospace">Biryani", price=280),</text>
      <text x="10" y="55" font-size="7" fill="#333" font-family="monospace">MenuItem(name="Lucknowi</text>
      <text x="10" y="65" font-size="7" fill="#333" font-family="monospace">Biryani", price=260)]</text>
    </g>

    <path d="M240 70 L300 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- LLM Manager -->
    <g transform="translate(320, 30)">
      <rect width="180" height="75" rx="5" fill="#f4ecf7" stroke="#9b59b6"/>
      <text x="90" y="18" text-anchor="middle" font-size="9" font-weight="bold" fill="#8e44ad">LLM Account Manager</text>
      <text x="90" y="35" text-anchor="middle" font-size="8" fill="#666">20 OpenAI Accounts</text>
      <text x="90" y="48" text-anchor="middle" font-size="8" fill="#666">Round-Robin Selection</text>
      <text x="90" y="61" text-anchor="middle" font-size="8" fill="#666">Rate Limit Handling</text>
      <text x="90" y="72" text-anchor="middle" font-size="7" fill="#999">Auto-failover on 429</text>
    </g>

    <path d="M520 70 L580 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- OpenAI -->
    <g transform="translate(600, 30)">
      <rect width="140" height="75" rx="8" fill="url(#llmGrad)" filter="url(#shadow)"/>
      <circle cx="70" cy="25" r="15" fill="white"/>
      <text x="70" y="30" text-anchor="middle" font-size="12" fill="#412991" font-weight="bold">AI</text>
      <text x="70" y="52" text-anchor="middle" fill="white" font-size="10" font-weight="bold">OpenAI</text>
      <text x="70" y="65" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">GPT-4o</text>
    </g>

    <path d="M760 70 L820 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- Response Generation -->
    <g transform="translate(840, 35)">
      <rect width="160" height="70" rx="5" fill="#ebf5fb" stroke="#3498db"/>
      <text x="80" y="18" text-anchor="middle" font-size="9" font-weight="bold" fill="#2980b9">Response Generator</text>
      <text x="80" y="35" text-anchor="middle" font-size="8" fill="#666">Format: Natural Language</text>
      <text x="80" y="48" text-anchor="middle" font-size="8" fill="#666">+ Card Data (MENU_CARD)</text>
      <text x="80" y="61" text-anchor="middle" font-size="8" fill="#666">+ Quick Replies</text>
    </g>

    <path d="M1020 70 L1080 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- AG-UI Events -->
    <g transform="translate(1100, 35)">
      <rect width="100" height="70" rx="5" fill="#fef9e7" stroke="#f39c12"/>
      <text x="50" y="18" text-anchor="middle" font-size="9" font-weight="bold" fill="#d68910">AG-UI</text>
      <text x="50" y="35" text-anchor="middle" font-size="7" fill="#666">TEXT_MESSAGE</text>
      <text x="50" y="47" text-anchor="middle" font-size="7" fill="#666">CARD_DATA</text>
      <text x="50" y="59" text-anchor="middle" font-size="7" fill="#666">RUN_FINISHED</text>
    </g>
  </g>

  <!-- STEP 6: Response Streaming -->
  <g transform="translate(140, 750)">
    <rect width="1220" height="110" rx="10" fill="white" stroke="#ddd" filter="url(#shadow)"/>
    <text x="20" y="25" font-size="14" font-weight="bold" fill="#333">STEP 6: Response Streaming to Client</text>

    <!-- AG-UI Event Stream -->
    <g transform="translate(40, 35)">
      <rect width="200" height="70" rx="5" fill="#e8f8f5" stroke="#1abc9c"/>
      <text x="100" y="15" text-anchor="middle" font-size="9" font-weight="bold" fill="#16a085">Streaming Events</text>
      <text x="10" y="32" font-size="7" fill="#333" font-family="monospace">{"type":"RUN_STARTED"}</text>
      <text x="10" y="44" font-size="7" fill="#333" font-family="monospace">{"type":"TEXT_MESSAGE",</text>
      <text x="10" y="54" font-size="7" fill="#333" font-family="monospace"> "content":"Found 2..."}</text>
      <text x="10" y="66" font-size="7" fill="#333" font-family="monospace">{"type":"CARD_DATA",...}</text>
    </g>

    <path d="M260 70 L320 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- WebSocket Send -->
    <g transform="translate(340, 30)">
      <rect width="140" height="75" rx="8" fill="url(#wsGrad)" filter="url(#shadow)"/>
      <text x="70" y="22" text-anchor="middle" fill="white" font-size="10" font-weight="bold">WebSocket</text>
      <text x="70" y="40" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="8">ws.send_json()</text>
      <text x="70" y="55" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">Real-time Push</text>
      <text x="70" y="68" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="8">Async Generator</text>
    </g>

    <path d="M500 70 L560 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- NGINX Proxy -->
    <g transform="translate(580, 35)">
      <rect width="100" height="70" rx="5" fill="url(#nginxGrad)"/>
      <text x="50" y="25" text-anchor="middle" fill="white" font-size="10" font-weight="bold">NGINX</text>
      <text x="50" y="42" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="8">WS Proxy</text>
      <text x="50" y="55" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="7">Upgrade: websocket</text>
    </g>

    <path d="M700 70 L760 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- Browser receives -->
    <g transform="translate(780, 35)">
      <rect width="180" height="70" rx="5" fill="#fff" stroke="#3498db" stroke-width="2"/>
      <rect x="5" y="5" width="170" height="15" rx="3" fill="#ecf0f1"/>
      <circle cx="15" cy="12" r="3" fill="#e74c3c"/>
      <circle cx="26" cy="12" r="3" fill="#f1c40f"/>
      <circle cx="37" cy="12" r="3" fill="#27ae60"/>
      <text x="90" y="35" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">React Event Handler</text>
      <text x="90" y="50" text-anchor="middle" font-size="8" fill="#666">onMessage(event)</text>
      <text x="90" y="62" text-anchor="middle" font-size="8" fill="#666">Update UI State</text>
    </g>

    <path d="M980 70 L1040 70" stroke="#667" stroke-width="2" marker-end="url(#arrow)"/>

    <!-- Final UI -->
    <g transform="translate(1060, 30)">
      <rect width="140" height="75" rx="8" fill="#fff" stroke="#27ae60" stroke-width="2" filter="url(#shadow)"/>
      <text x="70" y="20" text-anchor="middle" font-size="10" font-weight="bold" fill="#27ae60">User Sees</text>
      <rect x="10" y="28" width="120" height="40" rx="3" fill="#e8f8f5"/>
      <text x="70" y="42" text-anchor="middle" font-size="7" fill="#333">Found 2 biryani options</text>
      <text x="70" y="52" text-anchor="middle" font-size="7" fill="#333">under Rs.300:</text>
      <text x="70" y="62" text-anchor="middle" font-size="7" fill="#1abc9c">[Menu Cards]</text>
    </g>
  </g>

  <!-- Timing annotations -->
  <g transform="translate(1280, 100)">
    <rect width="100" height="200" rx="5" fill="white" stroke="#ddd"/>
    <text x="50" y="20" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">Timing</text>
    <line x1="10" y1="28" x2="90" y2="28" stroke="#ddd"/>
    <text x="50" y="50" text-anchor="middle" font-size="8" fill="#666">Step 1: ~5ms</text>
    <text x="50" y="70" text-anchor="middle" font-size="8" fill="#666">Step 2: ~10ms</text>
    <text x="50" y="90" text-anchor="middle" font-size="8" fill="#ee5a24">Step 3: ~200ms</text>
    <text x="50" y="110" text-anchor="middle" font-size="8" fill="#666">Step 4: ~50ms</text>
    <text x="50" y="130" text-anchor="middle" font-size="8" fill="#666">Step 5: ~800ms</text>
    <text x="50" y="150" text-anchor="middle" font-size="8" fill="#666">Step 6: ~5ms</text>
    <line x1="10" y1="160" x2="90" y2="160" stroke="#ddd"/>
    <text x="50" y="180" text-anchor="middle" font-size="9" font-weight="bold" fill="#27ae60">Total: ~1.1s</text>
  </g>

  <!-- Footer -->
  <text x="700" y="980" text-anchor="middle" font-size="10" fill="#999">Restaurant AI - Request Flow Architecture (CrewAI) | December 2025</text>
</svg>